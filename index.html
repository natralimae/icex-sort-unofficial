<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ICEx楽曲ランキングソート</title>

  <!-- Twitter / X -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="ICEx楽曲ランキングソート">
  <meta name="twitter:description" content="ICExの好きな楽曲ランキングを作れる非公式ソートです。">
  <meta name="twitter:image" content="https://natralimae.github.io/icex-sort-unofficial/ogp.jpg">

  <!-- OGP -->
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://natralimae.github.io/icex-sort-unofficial/">
  <meta property="og:title" content="ICEx楽曲ランキングソート">
  <meta property="og:description" content="ICExの好きな楽曲ランキングを作れる非公式ソートです。">
  <meta property="og:image" content="https://natralimae.github.io/icex-sort-unofficial/ogp.jpg">

  <style>
    body { font-family: system-ui, sans-serif; padding: 20px; margin: 0; }
    h1 { font-size: 1.6rem; }

    .card { border: 1px solid #ddd; border-radius: 12px; padding: 16px; margin-bottom: 20px; }

    .songs { display: flex; flex-direction: row; gap: 12px; }

    /* スマホ向け */
    @media (max-width: 600px) {
      .songs { flex-direction: column; }
      .center-options { flex-direction: row; width: 100%; }
      button { flex: 1; }
    }

    .song {
      flex: 1;
      text-align: center;
      border: 1px solid #ddd;
      border-radius: 12px;
      padding: 16px;
      cursor: pointer;
      background: #fafafa;
    }
    .song:hover { background: #f0f0f0; }

    .center-options {
      width: 160px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      justify-content: center;
      align-items: center;
    }

    button {
      padding: 10px 16px;
      border-radius: 10px;
      border: 1px solid #ddd;
      background: white;
      cursor: pointer;
      font-size: 1rem;
    }
    button:hover { background: #eee; }

    .progress-wrap { height:12px;background:#eee;border-radius:6px;overflow:hidden; margin: 10px 0; }
    #progressBar { height:100%;width:0%;background:#3b82f6; }

    #ranking li { margin-bottom: 6px; font-size: 1.1rem; }

    /* --- X投稿ボタンを大きく見やすく --- */
    #tweetButton {
      width: 100%;
      padding: 18px 0;
      margin-top: 20px;
      font-size: 1.2rem;
      font-weight: bold;
      border-radius: 12px;
      background: #000;
      color: #fff;
      border: none;
      cursor: pointer;
    }
    #tweetButton:hover {
      opacity: 0.85;
    }
  </style>
</head>

<body>
  <h1>ICEx楽曲ランキングソート</h1>
  <p>ICExの好きな楽曲ランキングが作れるソートです。</p>

  <div class="card">
    <div id="comparison" class="songs"></div>
    <div class="progress-wrap"><div id="progressBar"></div></div>
    <div class="muted" id="progressInfo"></div>
  </div>

  <h2 id="resultTitle" style="display:none;">最終ランキング</h2>
  <ol id="ranking" style="display:none;"></ol>

<script>
"use strict";

// ---- 楽曲リスト ----
const songs = [
  "CANDY","Sunny Road","Play The Music","COUNT DOWN","シブヤ 午後6時","ナイトフライト",
  "It`s party time!","Member Sign","ビリミ","Maniacs","Sunset Blue","Cyber Groovin'",
  "Hollywood","ダイ キ ライ","CARNIVAL","listen to your heart","Butterfly Echo","恋ソーダ",
  "Dash and Rush","Destiny","GIFT","8COUNT","理想郷","Miracles","BOOM BOOM BOOM",
  "運命の1ページ","青と白","インストール","ALPHA","Jelly Beans","Crazy Drive","Blue Wish",
  "We`re ICEx!","Welcome to BOKUNCHI","Da-Da-Da"
];

// ---- Elo 初期化 ----
let items = songs.map(title => ({ title, rating: 1500 }));
const MAX_COMPARISONS = 50;
const K = 32;
const BOTH_DELTA = K * 0.1;
const NEITHER_DELTA = K * 0.1;

let comparisonsDone = 0;
let currentPair = null;
let history = [];

function pickTwo() {
  let a = items[Math.floor(Math.random() * items.length)];
  let b = a;
  while (b === a) b = items[Math.floor(Math.random() * items.length)];
  return [a, b];
}

function expectedScore(rA, rB) {
  return 1 / (1 + Math.pow(10, (rB - rA) / 400));
}

function updateProgress() {
  const pct = Math.min(100, (comparisonsDone / MAX_COMPARISONS) * 100);
  document.getElementById("progressBar").style.width = pct + "%";
  document.getElementById("progressInfo").textContent = `${pct.toFixed(0)}% 完了`;
}

function renderPair() {
  updateProgress();
  if (!currentPair) return;

  const [left, right] = currentPair;

  document.getElementById('comparison').innerHTML = `
    <div class="song" onclick="choose('left')"><h3>${left.title}</h3></div>
    <div class="center-options">
      <button onclick="choose('both')">両方好き</button>
      <button onclick="choose('neither')">両方微妙</button>
      <button onclick="undo()">1つ戻る</button>
    </div>
    <div class="song" onclick="choose('right')"><h3>${right.title}</h3></div>
  `;
}

function choose(option) {
  const [A, B] = currentPair;

  history.push({ A, B, prevA: A.rating, prevB: B.rating, comparisonsBefore: comparisonsDone, option });

  const EA = expectedScore(A.rating, B.rating);
  const EB = 1 - EA;

  if (option === 'left') {
    A.rating += K * (1 - EA);
    B.rating += K * (0 - EB);
  } else if (option === 'right') {
    A.rating += K * (0 - EA);
    B.rating += K * (1 - EB);
  } else if (option === 'both') {
    A.rating += BOTH_DELTA;
    B.rating += BOTH_DELTA;
  } else if (option === 'neither') {
    A.rating -= NEITHER_DELTA;
    B.rating -= NEITHER_DELTA;
  }

  comparisonsDone++;
  if (comparisonsDone >= MAX_COMPARISONS) return finish();

  currentPair = pickTwo();
  renderPair();
}

function undo() {
  if (history.length === 0) return;
  const last = history.pop();
  last.A.rating = last.prevA;
  last.B.rating = last.prevB;
  comparisonsDone = last.comparisonsBefore;
  currentPair = [last.A, last.B];
  renderPair();
}

function finish() {
  updateProgress();
  document.getElementById("resultTitle").style.display = "block";
  document.getElementById("ranking").style.display = "block";

  const sorted = [...items].sort((a, b) => b.rating - a.rating);

  document.getElementById("ranking").innerHTML =
    sorted.map((s, i) => `<li>${s.title}</li>`).join('');

  // スマホでも押しやすい大きなボタン
  document.getElementById("ranking").insertAdjacentHTML(
    "afterend",
    `<button id="tweetButton" onclick="postToX()">X に投稿する</button>`
  );

  document.getElementById("comparison").innerHTML = "結果発表！";
  currentPair = null;
}

function postToX() {
  const sorted = [...items].sort((a, b) => b.rating - a.rating);

  let text = "ICEx楽曲ランキングソート 結果\n";
  for (let i = 0; i < sorted.length; i++) {
    const line = `${i + 1}. ${sorted[i].title}\n`;
    if ((text + line + "https://natralimae.github.io/icex-sort-unofficial/").length > 140) break;
    text += line;
  }

  text += "https://natralimae.github.io/icex-sort-unofficial/";

  const url = `https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}`;
  window.open(url);
}

currentPair = pickTwo();
renderPair();
</script>
</body>
</html>

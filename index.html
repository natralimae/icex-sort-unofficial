<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ICEx楽曲ランキングソート</title>
  <style>
    body { font-family: system-ui, sans-serif; padding: 20px; }
    .card { border: 1px solid #ddd; border-radius: 12px; padding: 20px; margin-bottom: 20px; }
    .songs { display: flex; gap: 12px; align-items: stretch; margin-bottom: 12px; }
    .song { flex: 1; text-align: center; border: 1px solid #ddd; border-radius: 12px; padding: 12px; cursor:pointer; }
    .song:hover { transform: translateY(-2px); }
    .center-options { width: 160px; display: flex; flex-direction: column; gap: 10px; justify-content: center; align-items: center; }
    button { padding: 10px 16px; border-radius: 10px; border: 1px solid #ddd; background: white; cursor: pointer; }
    button:hover { background: #eee; }
    .progress-wrap { height:12px;background:#eee;border-radius:6px;overflow:hidden; }
    #progressBar { height:100%;width:0%;background:#3b82f6; }
    .muted { color: #6b7280; font-size: 12px; }
  </style>
</head>
<body>
  <h1>ICEx楽曲ランキングソート</h1>
  <p>ICExの好きな楽曲ランキングが作れるソートです。</p>

  <div class="card">
    <div id="comparison" class="songs"></div>
    <div class="progress-wrap"><div id="progressBar"></div></div>
    <div class="muted" id="progressInfo"></div>
  </div>

  <h2 id="resultTitle" style="display:none;">最終ランキング</h2>
  <ol id="ranking" style="display:none;"></ol>

  <script>
"use strict";

// ---- 楽曲リスト ----
const songs = [
  "CANDY","Sunny Road","Play The Music","COUNT DOWN","シブヤ 午後6時","ナイトフライト",
  "It`s party time!","Member Sign","ビリミ","Maniacs","Sunset Blue","Cyber Groovin'",
  "Hollywood","ダイ　キ　ライ","CARNIVAL","listen to your heart","Butterfly Echo","恋ソーダ",
  "Dash and Rush","Destiny","GIFT","8COUNT","理想郷","Miracles","BOOM BOOM BOOM",
  "運命の1ページ","青と白","インストール","ALPHA","Jelly Beans","Crazy Drive","Blue Wish",
  "We`re ICEx!","Welcome to BOKUNCHI","Da-Da-Da"
];

// ---- Elo 初期化 ----
let items = songs.map(title => ({ title, rating: 1500 }));
const MAX_COMPARISONS = 50;
const K = 32;
const BOTH_DELTA = K * 0.1;
const NEITHER_DELTA = K * 0.1;

let comparisonsDone = 0;
let currentPair = null;
let history = [];

function pickTwo() {
  let a = items[Math.floor(Math.random() * items.length)];
  let b = a;
  while (b === a) b = items[Math.floor(Math.random() * items.length)];
  return [a, b];
}

function expectedScore(rA, rB) {
  return 1 / (1 + Math.pow(10, (rB - rA) / 400));
}

function updateProgress() {
  const pct = Math.min(100, (comparisonsDone / MAX_COMPARISONS) * 100);
  document.getElementById("progressBar").style.width = pct + "%";
  document.getElementById("progressInfo").textContent = `${comparisonsDone} / ${MAX_COMPARISONS} 比較済み`;
}

function renderPair() {
  updateProgress();
  if (!currentPair) return;
  const [left, right] = currentPair;

  document.getElementById('comparison').innerHTML = `
    <div class="song" onclick="choose('left')"><h3>${left.title}</h3></div>
    <div class="center-options">
      <button onclick="choose('both')">両方好き</button>
      <button onclick="choose('neither')">両方微妙</button>
      <button onclick="undo()">1つ戻る</button>
    </div>
    <div class="song" onclick="choose('right')"><h3>${right.title}</h3></div>
  `;
}

function choose(option) {
  const [A, B] = currentPair;

  history.push({
    A,
    B,
    prevA: A.rating,
    prevB: B.rating,
    comparisonsBefore: comparisonsDone,
    option
  });

  const EA = expectedScore(A.rating, B.rating);
  const EB = 1 - EA;

  if (option === 'left') {
    A.rating += K * (1 - EA);
    B.rating += K * (0 - EB);
  } else if (option === 'right') {
    A.rating += K * (0 - EA);
    B.rating += K * (1 - EB);
  } else if (option === 'both') {
    A.rating += BOTH_DELTA;
    B.rating += BOTH_DELTA;
  } else if (option === 'neither') {
    A.rating -= NEITHER_DELTA;
    B.rating -= NEITHER_DELTA;
  }

  comparisonsDone++;

  if (comparisonsDone >= MAX_COMPARISONS) {
    finish();
    return;
  }

  currentPair = pickTwo();
  renderPair();
}

function undo() {
  if (history.length === 0) return;
  const last = history.pop();
  last.A.rating = last.prevA;
  last.B.rating = last.prevB;
  comparisonsDone = last.comparisonsBefore;
  currentPair = [last.A, last.B];
  renderPair();
}

function finish() {
  updateProgress();
  document.getElementById("resultTitle").style.display = "block";
  document.getElementById("ranking").style.display = "block";

  const sorted = [...items].sort((a, b) => b.rating - a.rating);
  document.getElementById("ranking").innerHTML = `
    ${sorted.map((s, i) => `<li>${i + 1}. ${s.title}</li>`).join('')}
    <br><button onclick="postToX()">X に投稿</button>
  `;

  document.getElementById("comparison").innerHTML = "全ての比較が完了しました！";
  currentPair = null;
}

// ★ X 投稿（URL付き・140文字制限）
function postToX() {
  const sorted = [...items].sort((a, b) => b.rating - a.rating);
  const lines = [
    "ICEx楽曲ランキングソート 結果✨",
    ...sorted.map((s, i) => `${i + 1}. ${s.title}`)
  ];

  const sorterUrl = "https://naturalimae.github.io/icex-sort-unofficial/";

  let text = lines.join("\n") + "\n" + sorterUrl;

  if (text.length > 140) {
    const reserved = "\n" + sorterUrl;
    const limit = 140 - reserved.length - 1;
    text = lines.join("\n").slice(0, limit) + "…" + reserved;
  }

  const encoded = encodeURIComponent(text);
  window.open(`https://twitter.com/intent/tweet?text=${encoded}`);
}

// ---- 初期 ----
currentPair = pickTwo();
renderPair();
  </script>
</body>
</html>
